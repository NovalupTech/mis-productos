generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  relationMode = "prisma"
}

// -------------------------
// Enums
// -------------------------

enum Role {
  admin
  user
  companyAdmin
}

enum AttributeType {
  text
  number
  select
  multiselect
}

enum PageType {
  HOME
  CATALOG
  INFO
}

enum SectionType {
  HERO
  BANNER
  TEXT
  IMAGE
  FEATURES
  GALLERY
  CTA
  MAP
}

enum SocialType {
  INSTAGRAM
  FACEBOOK
  TIKTOK
  X
  LINKEDIN
  YOUTUBE
  WHATSAPP
  WEBSITE
}

// -------------------------
// Company (tus clientes)
// -------------------------

model Company {
  id        String   @id @default(uuid())
  name      String
  email     String?
  phone     String?
  address   String?
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  products       Product[]
  categories     Category[]
  attributes     Attribute[]
  customers      Customer[]
  orders         Order[]
  domains        Domain[]
  users          User[]
  pages          Page[]
  socials        CompanySocial[]
  configs        CompanyConfig[]
  tags           Tag[]
  paymentMethods PaymentMethod[]
  payments       Payment[]
}

// -------------------------
// Clientes finales de cada Company
// -------------------------

model Customer {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  phone     String?
  createdAt DateTime @default(now())

  company   Company @relation(fields: [companyId], references: [id])
  companyId String

  orders Order[]

  @@index([companyId])
}

// -------------------------
// Categorías por empresa
// -------------------------

model Category {
  id   String @id @default(uuid())
  name String

  company   Company @relation(fields: [companyId], references: [id])
  companyId String

  product Product[]

  @@unique([name, companyId])
  @@index([companyId])
}

// -------------------------
// Productos por empresa
// -------------------------

model Product {
  id          String  @id @default(uuid())
  title       String
  description String
  inStock     Int
  price       Float   @default(0)
  slug        String  @unique
  featured    Boolean @default(false)
  code        String?

  company   Company @relation(fields: [companyId], references: [id])
  companyId String

  category   Category @relation(fields: [categoryId], references: [id])
  categoryId String

  productImage     ProductImage[]
  OrderItem        OrderItem[]
  ProductAttribute ProductAttribute[]
  tags             ProductTag[]
  favorites        UserFavorite[]

  @@unique([companyId, code])
  @@index([companyId])
  @@index([categoryId])
}

// -------------------------
// Imágenes de productos
// -------------------------

model ProductImage {
  id        Int     @id @default(autoincrement())
  url       String
  product   Product @relation(fields: [productId], references: [id])
  productId String

  @@index([productId])
}

// -------------------------
// Usuarios del sistema (admins)
// -------------------------

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  emailVerified DateTime?
  password      String?
  phone         String?
  role          Role      @default(user)
  image         String?
  provider      String    @default("credentials") // "credentials" o "google"

  company   Company? @relation(fields: [companyId], references: [id])
  companyId String?

  UserAddress UserAddress?
  Order       Order[]
  favorites   UserFavorite[]

  @@index([companyId])
}

// -------------------------
// Países
// -------------------------

model Country {
  id           String         @id
  name         String
  UserAddress  UserAddress[]
  OrderAddress OrderAddress[]
}

// -------------------------
// Dirección de usuarios administradores
// -------------------------

model UserAddress {
  id         String  @id @default(uuid())
  firstName  String
  lastName   String
  address    String
  address2   String?
  postalCode String
  city       String
  phone      String

  country   Country @relation(fields: [countryId], references: [id])
  countryId String

  user   User   @relation(fields: [userId], references: [id])
  userId String @unique

  @@index([countryId])
}

// -------------------------
// Órdenes por empresa
// -------------------------

model Order {
  id            String    @id @default(uuid())
  subTotal      Float
  tax           Float
  total         Float
  itemsInOrder  Int
  isPaid        Boolean   @default(false)
  paidAt        DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  transactionId String?

  // Relaciones
  company   Company @relation(fields: [companyId], references: [id])
  companyId String

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  customer   Customer? @relation(fields: [customerId], references: [id])
  customerId String?

  OrderItem    OrderItem[]
  OrderAddress OrderAddress?
  payments     Payment[]

  @@index([companyId])
  @@index([userId])
  @@index([customerId])
}

// -------------------------
// Items de la orden
// -------------------------

model OrderItem {
  id       String @id @default(uuid())
  quantity Int
  price    Float

  order   Order  @relation(fields: [orderId], references: [id])
  orderId String

  product   Product @relation(fields: [productId], references: [id])
  productId String

  @@index([orderId])
  @@index([productId])
}

// -------------------------
// Dirección dentro de una orden
// -------------------------

model OrderAddress {
  id         String  @id @default(uuid())
  firstName  String
  lastName   String
  address    String
  address2   String?
  postalCode String
  city       String
  phone      String

  country   Country @relation(fields: [countryId], references: [id])
  countryId String

  Order   Order  @relation(fields: [orderId], references: [id])
  orderId String @unique

  @@index([countryId])
}

// -------------------------
// Atributos configurables por Company (EAV optimized)
// -------------------------

model Attribute {
  id       String        @id @default(uuid())
  name     String
  type     AttributeType
  required Boolean       @default(false)

  company   Company @relation(fields: [companyId], references: [id])
  companyId String

  values   AttributeValue[]
  products ProductAttribute[]

  @@unique([name, companyId])
  @@index([companyId])
}

// -------------------------
// Opciones de un atributo (para selects)
// -------------------------

model AttributeValue {
  id    String @id @default(uuid())
  value String

  attribute   Attribute @relation(fields: [attributeId], references: [id])
  attributeId String

  products ProductAttribute[]

  @@index([attributeId])
}

// -------------------------
// Valores asignados a productos
// -------------------------

model ProductAttribute {
  id String @id @default(uuid())

  product   Product @relation(fields: [productId], references: [id])
  productId String

  attribute   Attribute @relation(fields: [attributeId], references: [id])
  attributeId String

  attributeValue   AttributeValue? @relation(fields: [attributeValueId], references: [id])
  attributeValueId String?

  // Para atributos libres
  valueText   String?
  valueNumber Float?

  @@index([productId])
  @@index([attributeId])
  @@index([attributeValueId])
}

// -------------------------
// Tags para productos
// -------------------------

model Tag {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String

  products ProductTag[]

  @@unique([name, companyId])
  @@index([companyId])
}

// -------------------------
// Relación many-to-many entre Product y Tag
// -------------------------

model ProductTag {
  id String @id @default(uuid())

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String

  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId String

  @@unique([productId, tagId])
  @@index([productId])
  @@index([tagId])
}

// -------------------------
// Favoritos de usuarios
// -------------------------

model UserFavorite {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

// -------------------------
// Dominios por empresa
// -------------------------

model Domain {
  id        String   @id @default(uuid())
  domain    String   @unique
  isPrimary Boolean  @default(true)
  createdAt DateTime @default(now())

  company   Company @relation(fields: [companyId], references: [id])
  companyId String

  @@index([companyId])
  @@index([domain])
}

model PageSection {
  id     String @id @default(uuid())
  pageId String
  page   Page   @relation(fields: [pageId], references: [id], onDelete: Cascade)

  type     SectionType
  position Int
  content  Json
  enabled  Boolean     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pageId, position])
}

model Page {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  type      PageType
  slug      String
  title     String
  enabled   Boolean  @default(true)
  isLanding Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sections PageSection[]

  @@unique([companyId, type])
  @@unique([companyId, slug])
  @@index([companyId])
}

model CompanySocial {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  type    SocialType
  url     String
  label   String?
  enabled Boolean    @default(true)
  order   Int        @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, type])
  @@index([companyId])
}

model CompanyConfig {
  id        String @id @default(cuid())
  companyId String

  key   String
  value Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, key])
  @@index([companyId])
}

model Discount {
  id          String       @id @default(uuid())
  name        String
  description String?
  type        DiscountType
  value       Json?
  isActive    Boolean      @default(true)
  combinable  Boolean      @default(false)
  priority    Int          @default(0)
  startsAt    DateTime?
  endsAt      DateTime?

  targets    DiscountTarget[]
  conditions DiscountCondition[]

  createdAt DateTime @default(now())
}

model DiscountTarget {
  id         String             @id @default(uuid())
  discountId String
  targetType DiscountTargetType
  targetId   String?

  discount Discount @relation(fields: [discountId], references: [id])

  @@index([discountId])
}

model DiscountCondition {
  id            String                @id @default(uuid())
  discountId    String
  conditionType DiscountConditionType
  value         Float

  discount Discount @relation(fields: [discountId], references: [id])

  @@index([discountId])
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  BUY_X_GET_Y
}

enum DiscountTargetType {
  PRODUCT
  CATEGORY
  TAG
  ALL
}

enum DiscountConditionType {
  MIN_QUANTITY
  MIN_AMOUNT
}

model PaymentMethod {
  id        String @id @default(uuid())
  companyId String

  type    PaymentMethodType
  enabled Boolean           @default(false)

  config Json? // datos específicos del método

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id])

  @@unique([companyId, type])
}

enum PaymentMethodType {
  BANK_TRANSFER
  PAYPAL
  MERCADOPAGO
  CASH
  COORDINATE_WITH_SELLER
}

enum PaymentStatus {
  approved
  pending
  rejected
  refunded
  cancelled
}

// -------------------------
// Pagos registrados
// -------------------------

model Payment {
  id                String        @id @default(uuid())
  orderId           String
  companyId         String
  paymentId         String // ID del pago en Mercado Pago / PayPal
  paymentMethod     String? // credit_card, debit_card, account_money, etc.
  amount            Float
  currency          String        @default("USD")
  status            PaymentStatus @default(pending)
  statusDetail      String? // Detalle del status que viene del proveedor
  externalReference String? // Referencia interna opcional
  metadata          Json? // Datos adicionales en JSON

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([companyId])
  @@index([paymentId])
  @@index([status])
}
